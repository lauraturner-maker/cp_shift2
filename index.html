<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chipotle Crew Corner</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800;900&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #F4F1EB; }
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        /* Chipotle Texture */
        .texture-bg {
            background-image: url("data:image/svg+xml,%3Csvg width='6' height='6' viewBox='0 0 6 6' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23000000' fill-opacity='0.03' fill-rule='evenodd'%3E%3Cpath d='M5 0h1L0 6V5zM6 5v1H5z'/%3E%3C/g%3E%3C/svg%3E");
        }

        /* Utility for hiding elements */
        .hidden { display: none !important; }
        
        /* Toast Animation */
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .toast-enter { animation: slideUp 0.3s ease-out forwards; }
    </style>
</head>
<body>

    <!-- 1. LOADING STATE -->
    <div id="loader" class="h-screen flex items-center justify-center bg-[#F4F1EB]">
        <svg class="w-10 h-10 text-[#AD2118] spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
        </svg>
    </div>

    <!-- 2. MAIN DASHBOARD (Hidden by default) -->
    <div id="dashboard" class="hidden min-h-screen text-[#451400] texture-bg bg-[#F4F1EB]">
        
        <!-- Header -->
        <div class="bg-[#AD2118] text-white p-4 sticky top-0 z-10 shadow-lg border-b-4 border-[#8c1c14]">
            <div class="max-w-md mx-auto flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-[#8c1c14] rounded-full flex items-center justify-center border-2 border-[#c43e36]">
                        <!-- Utensils Icon -->
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2M7 2v20M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"></path></svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-extrabold uppercase tracking-tight leading-none">Crew Corner</h1>
                        <p class="text-xs text-red-100 font-bold uppercase tracking-wider opacity-80">Welcome, Team Member</p>
                    </div>
                </div>
                <div class="w-9 h-9 rounded-full bg-white/20 flex items-center justify-center">
                    <!-- Chef Hat Icon -->
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 13.87A4 4 0 0 1 7.41 6a5.11 5.11 0 0 1 1.05-1.54 5 5 0 0 1 7.08 0A5.11 5.11 0 0 1 16.59 6 4 4 0 0 1 18 13.87V21H6Z"/><line x1="6" x2="18" y1="17" y2="17"/></svg>
                </div>
            </div>
        </div>

        <div class="max-w-md mx-auto p-4 space-y-6 pb-24">
            
            <!-- Available Shifts Button -->
            <button onclick="window.toggleModal(true)" class="w-full bg-white border-2 border-[#451400] p-4 rounded-xl flex items-center justify-between shadow-md active:scale-[0.98] transition-all hover:bg-white/50 group">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-[#F4F1EB] flex items-center justify-center group-hover:bg-[#AD2118] group-hover:text-white transition-colors border border-[#e5e5e5]">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></svg>
                    </div>
                    <div class="text-left">
                        <h3 class="font-extrabold text-lg uppercase tracking-tight text-[#451400]">Available Shifts</h3>
                        <p class="text-sm text-slate-500 font-bold">2 shifts near you</p>
                    </div>
                </div>
                <div class="text-[#AD2118] font-extrabold text-sm uppercase tracking-widest px-3 py-1 bg-red-50 rounded-md">View</div>
            </button>

            <!-- Next Shift Card -->
            <div class="space-y-2">
                <h2 class="text-lg font-extrabold uppercase tracking-wide flex items-center gap-2 text-[#451400]">
                    <svg class="w-5 h-5 text-[#AD2118]" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.1.2-2.2.6-3.3.7 2.5 3 4.5 3 6.8Z"/></svg>
                    Manage Your Shift
                </h2>
                
                <div class="rounded-2xl p-6 text-white shadow-xl relative overflow-hidden" 
                     style="background-color: #AD2118; background-image: radial-gradient(circle at top right, #c43e36 0%, transparent 40%), radial-gradient(circle at bottom left, #8c1c14 0%, transparent 40%);">
                    
                    <!-- Watermark -->
                    <div class="absolute top-2 right-2 opacity-10 pointer-events-none transform rotate-12">
                        <svg width="180" height="180" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2M7 2v20M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"></path></svg>
                    </div>

                    <p class="text-red-100 font-bold uppercase text-xs tracking-widest mb-2 opacity-90">Your next shift</p>
                    
                    <div class="flex items-center gap-2 mb-6">
                        <svg class="w-4 h-4 text-white opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
                        <span class="font-bold text-white text-sm tracking-wide">Lafayette - #32057</span>
                    </div>

                    <div class="mb-8 relative z-10">
                        <h3 class="text-6xl font-black tracking-tighter mb-2 leading-none">Prep</h3>
                        <div class="flex flex-wrap items-center gap-3 mt-4 text-sm font-bold">
                            <div class="bg-black/20 px-3 py-1.5 rounded-md backdrop-blur-sm uppercase tracking-wide">
                                Tomorrow
                            </div>
                            <div class="bg-black/20 px-3 py-1.5 rounded-md backdrop-blur-sm flex items-center gap-2 uppercase tracking-wide">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                10:00 AM - 6:00 PM
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-3 relative z-10">
                        <button class="flex-1 bg-transparent border-2 border-white/50 hover:bg-white/10 text-white py-3 rounded-full font-extrabold text-xs uppercase tracking-widest transition-colors">
                            Details
                        </button>
                        <button onclick="window.handleSwapRequest('s1')" class="flex-1 bg-white text-[#AD2118] py-3 rounded-full font-extrabold text-xs uppercase tracking-widest shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2 hover:bg-gray-50">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M8 3 4 7l4 4"/><path d="M4 7h16"/><path d="m16 21 4-4-4-4"/><path d="M20 17H4"/></svg>
                            Swap
                        </button>
                    </div>
                </div>
            </div>

            <!-- Upcoming Schedule List -->
            <div class="space-y-4">
                <div class="flex items-center justify-between border-b border-[#e5e5e5] pb-2">
                    <h2 class="text-lg font-extrabold uppercase text-[#451400] tracking-wide">Upcoming Schedule</h2>
                    <button class="text-[#AD2118] text-xs font-extrabold uppercase tracking-widest hover:underline">See Full Calendar</button>
                </div>
                
                <!-- Container for dynamic shifts -->
                <div id="upcoming-list" class="space-y-4"></div>
            </div>
        </div>
    </div>

    <!-- 3. MODAL (Available Shifts) -->
    <div id="available-modal" class="hidden fixed inset-0 bg-[#451400]/80 z-50 flex items-end sm:items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-[#F4F1EB] w-full max-w-md rounded-t-3xl sm:rounded-3xl max-h-[85vh] overflow-y-auto shadow-2xl">
            <div class="sticky top-0 bg-[#F4F1EB] p-5 border-b border-[#e5e5e5] flex items-center justify-between z-10">
                <h2 class="text-xl font-black uppercase text-[#451400] tracking-tight">Shift Marketplace</h2>
                <button onclick="window.toggleModal(false)" class="p-2 hover:bg-slate-200 rounded-full transition-colors">
                    <svg class="w-6 h-6 text-[#451400]" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                </button>
            </div>
            
            <div class="p-5 space-y-4">
                <p class="text-sm font-bold text-slate-500 mb-2 uppercase tracking-wide">Tap a shift to claim it</p>
                <!-- Container for dynamic available shifts -->
                <div id="available-list" class="space-y-4"></div>
            </div>
        </div>
    </div>

    <!-- 4. TOAST CONTAINER -->
    <div id="toast-container" class="fixed bottom-6 left-4 right-4 z-[60] pointer-events-none"></div>

    <!-- FIREBASE & APP LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";

        // --- DATA ---
        const LOCATIONS = [
            "Lafayette - #32057",
            "Boulder - Pearl St - #1421",
            "Denver - Union Station - #2291"
        ];

        const UPCOMING_SHIFTS = [
            // Next Shift is hardcoded in HTML for hero, these are the list items
            { id: 's2', date: 'Wed, Oct 23', time: '4:00 PM - 10:00 PM', role: 'Grill', location: LOCATIONS[0] },
            { id: 's3', date: 'Fri, Oct 25', time: '6:00 AM - 2:00 PM', role: 'Tortilla', location: LOCATIONS[1] },
        ];

        const AVAILABLE_SHIFTS = [
            { id: 'a1', date: 'Thu, Oct 24', time: '11:00 AM - 3:00 PM', role: 'Cashier', location: LOCATIONS[2] },
            { id: 'a2', date: 'Sat, Oct 26', time: '5:00 PM - Close', role: 'Line', location: LOCATIONS[0] },
        ];

        const ALL_SHIFTS_MAP = {
            's1': { id: 's1', date: 'Tomorrow', time: '10:00 AM - 6:00 PM', role: 'Prep', location: LOCATIONS[0] }, // Hero shift
            ...UPCOMING_SHIFTS.reduce((acc, s) => ({...acc, [s.id]: s}), {}),
            ...AVAILABLE_SHIFTS.reduce((acc, s) => ({...acc, [s.id]: s}), {})
        };

        // --- ICONS SVG STRINGS ---
        const ICONS = {
            MapPin: `<svg class="w-4 h-4 text-[#AD2118]" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>`,
            Calendar: `<svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>`,
            Clock: `<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>`,
            Utensils: `<svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2M7 2v20M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"></path></svg>`
        };

        // --- RENDER FUNCTIONS ---
        function renderUpcoming() {
            const container = document.getElementById('upcoming-list');
            container.innerHTML = UPCOMING_SHIFTS.map(shift => `
                <div class="bg-white rounded-xl shadow-sm border border-[#E5E5E5] overflow-hidden p-5 flex flex-col gap-4 group hover:border-[#AD2118]/30 transition-colors">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-2xl font-black text-[#451400] mb-1 tracking-tight">${shift.role}</h3>
                            <div class="flex items-center gap-2 text-slate-500 text-sm font-bold">
                                ${ICONS.MapPin}
                                ${shift.location}
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-extrabold text-[#451400] text-lg">${shift.date}</div>
                            <div class="text-xs font-bold text-slate-500 uppercase tracking-wide">${shift.time}</div>
                        </div>
                    </div>
                    
                    <div class="pt-3 border-t border-dashed border-slate-200">
                        <button onclick="window.handleSwapRequest('${shift.id}')" 
                                class="w-full bg-white border-2 border-[#451400] text-[#451400] hover:bg-[#F4F1EB] px-4 py-2.5 rounded-full font-extrabold uppercase tracking-widest text-xs transition-all active:scale-95">
                            Request Swap
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function renderAvailable() {
            const container = document.getElementById('available-list');
            container.innerHTML = AVAILABLE_SHIFTS.map(shift => `
                <div class="bg-white p-5 rounded-xl shadow-sm border-2 border-[#e5e5e5] hover:border-[#AD2118] transition-colors flex flex-col gap-4">
                    <div class="flex justify-between items-start">
                        <div class="bg-green-100 text-green-800 text-[10px] font-black px-2 py-1 rounded uppercase tracking-widest inline-block border border-green-200">
                            Open
                        </div>
                        <span class="text-slate-400 text-xs font-bold uppercase tracking-wide">3.5 miles</span>
                    </div>
                    
                    <div class="flex items-center gap-4">
                        <div class="w-14 h-14 bg-red-50 rounded-xl flex items-center justify-center text-[#AD2118] border border-red-100">
                            ${ICONS.Calendar}
                        </div>
                        <div>
                            <h3 class="font-black text-[#451400] text-xl leading-none mb-1">${shift.date}</h3>
                            <p class="text-slate-600 text-sm font-bold flex items-center gap-1 uppercase tracking-wide">
                                ${ICONS.Clock} ${shift.time}
                            </p>
                        </div>
                    </div>

                    <div class="flex justify-between items-center text-xs font-bold text-slate-500 pt-3 border-t border-slate-100">
                        <span class="text-[#AD2118] text-sm uppercase">${shift.role}</span>
                        <span class="uppercase tracking-tight">${shift.location}</span>
                    </div>

                    <button onclick="window.handleRequestShift('${shift.id}')" 
                            class="w-full bg-[#AD2118] text-white shadow-lg hover:shadow-xl hover:opacity-95 px-4 py-3 rounded-full font-extrabold uppercase tracking-widest text-xs transition-all active:scale-95 mt-1">
                        Request Shift
                    </button>
                </div>
            `).join('');
        }

        // --- GLOBAL ACTIONS ---
        window.toggleModal = (show) => {
            const modal = document.getElementById('available-modal');
            if (show) modal.classList.remove('hidden');
            else modal.classList.add('hidden');
        };

        window.showToast = (title, message) => {
            const container = document.getElementById('toast-container');
            const toastEl = document.createElement('div');
            toastEl.className = 'bg-[#451400] text-white p-5 rounded-xl shadow-2xl flex items-start gap-4 max-w-md mx-auto border-l-4 border-[#AD2118] toast-enter pointer-events-auto';
            toastEl.innerHTML = `
                <div class="bg-green-500 rounded-full p-1.5 shrink-0 mt-0.5 shadow-lg">
                    ${ICONS.Utensils}
                </div>
                <div>
                    <h4 class="font-black text-sm uppercase tracking-widest mb-1">${title}</h4>
                    <p class="text-sm text-gray-200 leading-snug font-medium opacity-90">${message}</p>
                </div>
            `;
            container.appendChild(toastEl);
            setTimeout(() => {
                toastEl.style.opacity = '0';
                toastEl.style.transform = 'translateY(100%)';
                toastEl.style.transition = 'all 0.3s ease-out';
                setTimeout(() => toastEl.remove(), 300);
            }, 5000);
        };

        const sendApiNotification = async (messageText) => {
            try {
                const url = "https://app.staffbase.com/api/branch/notifications";
                const authHeader = "Basic NjgzNjc4ZDVjYTRjODk3MThhZjQxMDRiOl1TT3swcl8yKkRsMlNbcVpRaXY4RSwwKzdZbSE3KChXcVMsXkpZYlN5cTFuTW9FKUY2UyQkLEoqUy5ZRkRCK30=";
                
                // Fire and forget, or await. We'll fire and forget in UI but log error.
                // Note: CORS might block this in browser, but will work in correct environment.
                await fetch(url, {
                    method: "POST",
                    headers: { "Authorization": authHeader, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        accessorIds: ["6894b616a155797a6ce78bb2"],
                        channels: ["notificationCenter", "push"],
                        content: { en_US: { text: messageText }, de_DE: { text: messageText } },
                        icon: { en_US: { type: "font", char: "n" }, de_DE: { type: "font", char: "n" } },
                        image: { en_US: { type: "image", href: "https://cdn-icons-png.flaticon.com/512/8677/8677730.png", width: 600, height: 400 }, de_DE: { type: "image", href: "https://cdn-icons-png.flaticon.com/512/8677/8677730.png", width: 600, height: 400 } },
                        link: "https://knowledgepass.kronos.com/auth/saml/login.php"
                    })
                });
            } catch (e) { console.error("API Error", e); }
        };

        const sendBrowserNotif = (title, body) => {
            if (!("Notification" in window)) return;
            if (Notification.permission === "granted") new Notification(title, { body });
            else if (Notification.permission !== "denied") Notification.requestPermission().then(p => { if(p==="granted") new Notification(title, { body }); });
        };

        window.handleSwapRequest = async (shiftId) => {
            const shift = ALL_SHIFTS_MAP[shiftId];
            window.showToast("Request Sent", "Your shift change request has been sent to your manager. An update will be provided soon.");
            sendBrowserNotif("Shift Swap Requested", `Request for ${shift.date} sent to manager.`);
            await sendApiNotification(`Shift Swap Initiated: ${shift.role} on ${shift.date}`);
        };

        window.handleRequestShift = async (shiftId) => {
            const shift = ALL_SHIFTS_MAP[shiftId];
            window.toggleModal(false);
            window.showToast("Shift Requested", `You requested ${shift.role} on ${shift.date}.`);
            sendBrowserNotif("Shift Requested", `You requested: ${shift.role}`);
            await sendApiNotification(`Open Shift Requested: ${shift.role} at ${shift.location}`);
        };

        // --- AUTH & INIT ---
        const init = async () => {
            // Render static lists immediately
            renderUpcoming();
            renderAvailable();

            try {
                // Setup Firebase
                // 1. Check for Config
                const firebaseConfig = JSON.parse(window.__firebase_config || '{}');
                
                // 2. Validate Config (Must have at least an API Key)
                if (!firebaseConfig.apiKey) {
                    throw new Error("Missing Firebase Config");
                }

                // 3. Initialize if valid
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);

                // Auth State Listener
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        // Hide loader, Show Dashboard
                        document.getElementById('loader').classList.add('hidden');
                        document.getElementById('dashboard').classList.remove('hidden');
                    }
                });

                // Perform Login
                if (typeof window.__initial_auth_token !== 'undefined' && window.__initial_auth_token) {
                    await signInWithCustomToken(auth, window.__initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

            } catch (err) {
                console.warn("Auth/Init Failed (Falling back to Demo Mode):", err);
                
                // Fallback: If Auth fails or Config is missing, SHOW DASHBOARD anyway
                // This prevents the "spinning wheel of death"
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');

                // Optional: Notify user they are in demo mode if it was a config error
                if (err.message === "Missing Firebase Config") {
                    console.log("Running in Demo Mode (No backend connected)");
                } else {
                    // Actual Auth Error (show to user just in case)
                     console.error("Firebase Error details:", err);
                }
            }
        };

        // Start
        init();

    </script>
</body>
</html>
